language: python
notifications:
   email: false
archive: true

build:
  pre_ci_boot:
      image_name: brettbj/continuous_analysis_base
      image_tag: latest
      pull: true
      options: "-e HOME=/root"

  ci:
    - cd /root/src/github.com/greenelab/continuous_analysis
    - nose2 --plugin nose2.plugins.junitxml --junit-xml test 
    - mv nose2-junit.xml shippable/testresults/tests.xml
    - coverage run --branch test.py
    - coverage xml -o shippable/codecoverage/coverage.xml test.py

    - cd /kallisto/test
    - kallisto index -i transcripts.idx transcripts.fasta.gz
    - kallisto quant -i transcripts.idx -o output -b 100 reads_1.fastq.gz reads_2.fastq.gz
    - mv /kallisto/test/output /var/cache/drone/src/github.com/greenelab/continuous_analysis/drone/output

  post_ci:
    - docker build -t brettbj/continuous_analysis .
    - docker push brettbj/continuous_analysis:latest

integrations:
  hub:
    - integrationName: brettbj/continuous_analysis
      type: docker